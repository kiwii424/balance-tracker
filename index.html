<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日餘額計算器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-1: #0f172a;
            --bg-2: #0b3b49;
            --accent: #ff8a5b;
            --accent-2: #4ecdc4;
            --card: #f8f7f4;
            --ink: #0b1220;
            --muted: #6b7280;
            --line: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Space Grotesk", "Noto Sans TC", sans-serif;
            background: radial-gradient(circle at 10% 10%, rgba(255, 138, 91, 0.2), transparent 45%),
                radial-gradient(circle at 90% 15%, rgba(78, 205, 196, 0.2), transparent 45%),
                linear-gradient(160deg, var(--bg-1), var(--bg-2));
            color: var(--ink);
            min-height: 100vh;
            padding: 32px 20px 60px;
        }

        .container {
            max-width: 1080px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            color: #f8fafc;
        }

        header h1 {
            font-size: clamp(1.8rem, 3vw, 2.6rem);
            letter-spacing: 0.02em;
        }

        header p {
            color: rgba(248, 250, 252, 0.8);
            max-width: 620px;
            line-height: 1.6;
        }

        .card {
            background: var(--card);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.2);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .stat {
            background: #ffffff;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--line);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat label {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ink);
        }

        .stat .value.negative {
            color: #dc2626;
        }

        .stat input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--line);
            font-size: 1rem;
            background: #fdfdfc;
        }

        .grid-two {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #111827;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            font-size: 1rem;
            font-family: inherit;
            background: #ffffff;
        }

        input:focus, textarea:focus {
            outline: 2px solid rgba(255, 138, 91, 0.4);
            border-color: var(--accent);
        }

        .action-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .date-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }

        .date-row .field {
            min-width: 220px;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 12px 22px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.95rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .primary {
            background: var(--accent);
            color: #111827;
            box-shadow: 0 12px 24px rgba(255, 138, 91, 0.35);
        }

        .ghost {
            background: #111827;
            color: #f9fafb;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .future-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .day-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--line);
            display: grid;
            grid-template-columns: 160px 1fr 140px;
            gap: 12px;
            align-items: start;
        }

        .day-card h4 {
            font-size: 1rem;
            color: var(--ink);
        }

        .events {
            display: flex;
            flex-direction: column;
            gap: 6px;
            color: var(--muted);
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            font-size: 0.95rem;
        }

        .event-info {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .event-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .mini-btn {
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.8rem;
            border: 1px solid var(--line);
            background: #ffffff;
            color: #111827;
            cursor: pointer;
        }

        .mini-btn.edit {
            border-color: rgba(255, 138, 91, 0.6);
            color: #9a3412;
        }

        .mini-btn.delete {
            border-color: rgba(220, 38, 38, 0.4);
            color: #b91c1c;
        }

        .balance {
            font-weight: 700;
            text-align: right;
        }

        .balance.negative {
            color: #b91c1c;
        }

        .balance.low {
            background: rgba(251, 146, 60, 0.2);
            border-radius: 999px;
            padding: 6px 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .muted {
            color: var(--muted);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            font-size: 0.85rem;
            color: var(--muted);
            border-bottom: 1px solid var(--line);
            padding-bottom: 8px;
        }

        tbody td {
            padding: 10px 0;
            border-bottom: 1px dashed var(--line);
        }

        .table-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .amount.positive {
            color: #059669;
            font-weight: 600;
        }

        .amount.negative {
            color: #dc2626;
            font-weight: 600;
        }

        .empty {
            padding: 14px 0;
            color: var(--muted);
        }

        @media (max-width: 860px) {
            .day-card {
                grid-template-columns: 1fr;
            }

            .balance {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>每日餘額計算器</h1>
        </header>

        <section class="card">
            <div class="date-row">
                <div class="field">
                    <label for="todayDate">今天日期</label>
                    <input type="date" id="todayDate" disabled>
                </div>
                <div class="action-row">
                    <button class="ghost" id="exportBtn" type="button">匯出</button>
                    <button class="ghost" id="importBtn" type="button">匯入（覆蓋）</button>
                    <input type="file" id="importFileInput" accept="application/json" style="display: none;">
                </div>
            </div>
        </section>

        <section class="card">
            <div class="stats">
                <div class="stat">
                    <label>總資產</label>
                    <div class="value" id="totalAssets">0</div>
                </div>
                <div class="stat">
                    <label>當日餘額</label>
                    <div class="value" id="todayBalance">0</div>
                </div>
                <div class="stat">
                    <label for="cashInput">資金（當前餘額）</label>
                    <input type="number" id="cashInput" placeholder="輸入資金">
                </div>
                <div class="stat">
                    <label for="stockInput">股票市值</label>
                    <input type="number" id="stockInput" placeholder="輸入股票市值">
                </div>
            </div>
            <div class="action-row" style="align-items: center;">
                <button class="primary" id="settleTodayBtn" type="button">更新資金為今日餘額</button>
                <span class="muted">日期跨日時會自動結轉，也可以手動執行。</span>
            </div>
        </section>

        <section class="card">
            <div class="section-title">新增事件</div>
            <div class="grid-two">
                <div class="field">
                    <label for="eventDate">日期</label>
                    <input type="date" id="eventDate">
                </div>
                <div class="field">
                    <label for="eventTitle">事件</label>
                    <input type="text" id="eventTitle" placeholder="例如：股票、房租、獎金">
                </div>
                <div class="field">
                    <label for="eventAmount">金額</label>
                    <input type="number" id="eventAmount" placeholder="例如：-12786 或 13437">
                </div>
            </div>
            <div class="action-row">
                <button class="primary" id="addEventBtn">加入事件</button>
                <button class="ghost" id="clearEventsBtn">清除全部事件</button>
            </div>
        </section>

        <section class="card">
            <div class="section-title">未來日期餘額</div>
            <div class="future-list" id="futureList"></div>
        </section>

        <section class="card">
            <div class="section-title">已經經過的日期</div>
            <div id="pastList"></div>
        </section>
    </div>

    <script>
        const state = {
            cash: 0,
            stock: 0,
            todayDate: "",
            events: []
        };

        const totalAssetsEl = document.getElementById("totalAssets");
        const cashInput = document.getElementById("cashInput");
        const stockInput = document.getElementById("stockInput");
        const todayDateInput = document.getElementById("todayDate");
        const eventDateInput = document.getElementById("eventDate");
        const eventTitleInput = document.getElementById("eventTitle");
        const eventAmountInput = document.getElementById("eventAmount");
        const addEventBtn = document.getElementById("addEventBtn");
        const clearEventsBtn = document.getElementById("clearEventsBtn");
        const exportBtn = document.getElementById("exportBtn");
        const importBtn = document.getElementById("importBtn");
        const importFileInput = document.getElementById("importFileInput");
        const futureList = document.getElementById("futureList");
        const pastList = document.getElementById("pastList");
        const todayBalanceEl = document.getElementById("todayBalance");
        const settleTodayBtn = document.getElementById("settleTodayBtn");

        const STORAGE_KEY = "dailyBalanceTracker";

        function formatNumber(value) {
            return Number(value || 0).toLocaleString("zh-TW", {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }

        function formatDateLabel(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            return date.toLocaleDateString("zh-TW", { month: "numeric", day: "numeric" });
        }

        function parseDate(dateStr) {
            return new Date(`${dateStr}T00:00:00`);
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function toDateInputValue(date) {
            return date.toISOString().split("T")[0];
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            const today = toDateInputValue(new Date());
            if (!saved) {
                state.todayDate = today;
                return;
            }
            try {
                const data = JSON.parse(saved);
                Object.assign(state, data);
            } catch (error) {
                state.todayDate = today;
            }
            if (!state.todayDate) {
                state.todayDate = today;
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function renderTotals() {
            const todayBalance = getTodayBalance();
            const total = todayBalance + Number(state.stock || 0);
            totalAssetsEl.textContent = formatNumber(total);
            if (todayBalanceEl) {
                todayBalanceEl.textContent = formatNumber(todayBalance);
                todayBalanceEl.classList.toggle("negative", todayBalance < 0);
            }
        }

        function getTodayBalance() {
            const today = parseDate(state.todayDate);
            const pastTotal = state.events
                .filter((event) => parseDate(event.date) <= today)
                .reduce((sum, event) => sum + Number(event.amount || 0), 0);
            return Number(state.cash || 0) + pastTotal;
        }

        function computeBalanceUpTo(targetDate) {
            const target = parseDate(targetDate);
            const appliedEvents = state.events.filter((event) => parseDate(event.date) <= target);
            const appliedSum = appliedEvents.reduce((sum, event) => sum + Number(event.amount || 0), 0);
            return { target, appliedSum };
        }

        function settleToDate(targetDate) {
            const { target, appliedSum } = computeBalanceUpTo(targetDate);
            state.cash = Number(state.cash || 0) + appliedSum;
            state.events = state.events.filter((event) => parseDate(event.date) > target);
            state.todayDate = targetDate;
            saveState();
            syncInputs();
            renderAll();
        }

        function renderFutureList() {
            futureList.innerHTML = "";
            const today = parseDate(state.todayDate);
            const futureEvents = state.events
                .filter((event) => parseDate(event.date) > today)
                .sort((a, b) => parseDate(a.date) - parseDate(b.date));

            if (futureEvents.length === 0) {
                futureList.innerHTML = '<div class="empty">目前沒有未來事件。</div>';
                return;
            }

            const uniqueDates = [...new Set(futureEvents.map((event) => event.date))]
                .sort((a, b) => parseDate(a) - parseDate(b));
            let runningBalance = getTodayBalance();
            const daySummaries = uniqueDates.map((dateStr) => {
                const events = futureEvents.filter((event) => event.date === dateStr);
                const dailySum = events.reduce((sum, event) => sum + Number(event.amount || 0), 0);
                runningBalance += dailySum;
                return {
                    dateStr,
                    events,
                    balance: runningBalance
                };
            });

            const minBalance = Math.min(...daySummaries.map((day) => day.balance));

            daySummaries.forEach((day) => {
                const dayCard = document.createElement("div");
                dayCard.className = "day-card";

                const dateEl = document.createElement("h4");
                dateEl.textContent = formatDateLabel(day.dateStr);

                const eventsEl = document.createElement("div");
                eventsEl.className = "events";

                day.events.forEach((event) => {
                    const item = document.createElement("div");
                    item.className = "event-item";

                    const info = document.createElement("div");
                    info.className = "event-info";

                    const titleSpan = document.createElement("span");
                    titleSpan.textContent = event.title;

                    const amountSpan = document.createElement("span");
                    const amountClass = Number(event.amount) >= 0 ? "positive" : "negative";
                    amountSpan.className = `amount ${amountClass}`;
                    amountSpan.textContent = formatNumber(event.amount);

                    info.append(titleSpan, amountSpan);

                    const actions = document.createElement("div");
                    actions.className = "event-actions";

                    const editBtn = document.createElement("button");
                    editBtn.type = "button";
                    editBtn.className = "mini-btn edit";
                    editBtn.dataset.action = "edit";
                    editBtn.dataset.id = String(event.id);
                    editBtn.textContent = "編輯";

                    const deleteBtn = document.createElement("button");
                    deleteBtn.type = "button";
                    deleteBtn.className = "mini-btn delete";
                    deleteBtn.dataset.action = "delete";
                    deleteBtn.dataset.id = String(event.id);
                    deleteBtn.textContent = "刪除";

                    actions.append(editBtn, deleteBtn);
                    item.append(info, actions);
                    eventsEl.appendChild(item);
                });

                const balanceEl = document.createElement("div");
                const isLowest = day.balance === minBalance;
                const balanceClasses = ["balance"];
                if (isLowest) balanceClasses.push("low");
                if (day.balance < 0) balanceClasses.push("negative");
                balanceEl.className = balanceClasses.join(" ");
                balanceEl.textContent = `餘額：${formatNumber(day.balance)}`;

                dayCard.append(dateEl, eventsEl, balanceEl);
                futureList.appendChild(dayCard);
            });
        }

        function renderPastList() {
            const today = parseDate(state.todayDate);
            const pastEvents = state.events
                .filter((event) => parseDate(event.date) <= today)
                .sort((a, b) => parseDate(b.date) - parseDate(a.date));

            if (pastEvents.length === 0) {
                pastList.innerHTML = '<div class="empty">目前沒有過去紀錄。</div>';
                return;
            }

            const rows = pastEvents.map((event) => {
                const amountClass = Number(event.amount) >= 0 ? "positive" : "negative";
                return `
                    <tr>
                        <td>${formatDateLabel(event.date)}</td>
                        <td>${event.title}</td>
                        <td class="amount ${amountClass}">${formatNumber(event.amount)}</td>
                        <td class="table-actions">
                            <button type="button" class="mini-btn edit" data-action="edit" data-id="${event.id}">編輯</button>
                            <button type="button" class="mini-btn delete" data-action="delete" data-id="${event.id}">刪除</button>
                        </td>
                    </tr>
                `;
            }).join("");

            pastList.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>事件</th>
                            <th>金額</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        function renderAll() {
            renderTotals();
            renderFutureList();
            renderPastList();
        }

        function findEventIndexById(id) {
            return state.events.findIndex((event) => event.id === id);
        }

        function deleteEvent(id) {
            if (!confirm("確定要刪除此事件嗎？")) {
                return;
            }
            state.events = state.events.filter((event) => event.id !== id);
            saveState();
            renderAll();
        }

        function editEvent(id) {
            const index = findEventIndexById(id);
            if (index === -1) {
                return;
            }
            const target = state.events[index];

            const date = prompt("日期 (YYYY-MM-DD)：", target.date);
            if (date === null) return;

            const title = prompt("事件名稱：", target.title);
            if (title === null) return;

            const amountInput = prompt("金額（有正負）：", String(target.amount));
            if (amountInput === null) return;

            const amount = Number(amountInput);
            if (!date || !title.trim() || Number.isNaN(amount)) {
                alert("請輸入正確的日期、事件名稱與金額。");
                return;
            }

            state.events[index] = {
                ...target,
                date,
                title: title.trim(),
                amount
            };
            saveState();
            renderAll();
        }

        function handleEventAction(event) {
            const button = event.target.closest("button[data-action]");
            if (!button) return;

            const id = Number(button.dataset.id);
            if (Number.isNaN(id)) return;

            if (button.dataset.action === "edit") {
                editEvent(id);
                return;
            }

            if (button.dataset.action === "delete") {
                deleteEvent(id);
            }
        }

        function syncInputs() {
            cashInput.value = state.cash || "";
            stockInput.value = state.stock || "";
            todayDateInput.value = state.todayDate;
            eventDateInput.value = state.todayDate;
        }

        function handleDateRollover() {
            const actualToday = toDateInputValue(new Date());
            const storedDate = state.todayDate || actualToday;
            if (parseDate(actualToday) > parseDate(storedDate)) {
                settleToDate(actualToday);
                return true;
            }
            state.todayDate = actualToday;
            saveState();
            return false;
        }

        function addEvent() {
            const date = eventDateInput.value;
            const title = eventTitleInput.value.trim();
            const amount = Number(eventAmountInput.value);

            if (!date || !title || Number.isNaN(amount)) {
                alert("請完整輸入日期、事件與金額。");
                return;
            }

            state.events.push({
                id: Date.now(),
                date,
                title,
                amount
            });

            eventTitleInput.value = "";
            eventAmountInput.value = "";
            saveState();
            renderAll();
        }

        function clearEvents() {
            if (!confirm("確定要清除全部事件嗎？")) {
                return;
            }
            state.events = [];
            saveState();
            renderAll();
        }

        function buildExportData() {
            return {
                type: "daily-balance",
                version: 1,
                exportedAt: new Date().toISOString(),
                todayDate: state.todayDate,
                cash: Number(state.cash || 0),
                stock: Number(state.stock || 0),
                events: state.events.map((event) => ({
                    id: event.id,
                    date: event.date,
                    title: event.title,
                    amount: Number(event.amount || 0)
                }))
            };
        }

        function handleExport() {
            const payload = buildExportData();
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const stamp = toDateInputValue(new Date());
            link.href = url;
            link.download = `daily-balance-${stamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function applyImportedData(data) {
            if (!data || data.type !== "daily-balance" || data.version !== 1) {
                alert("檔案格式不正確，請使用匯出的 JSON 檔。");
                return false;
            }

            const importedEvents = Array.isArray(data.events) ? data.events : [];
            state.cash = Number(data.cash || 0);
            state.stock = Number(data.stock || 0);
            state.todayDate = data.todayDate || toDateInputValue(new Date());
            state.events = importedEvents.map((event, index) => ({
                id: typeof event.id === "number" ? event.id : Date.now() + index,
                date: String(event.date || ""),
                title: String(event.title || ""),
                amount: Number(event.amount || 0)
            })).filter((event) => event.date && event.title);

            const settled = handleDateRollover();
            if (settled) {
                return true;
            }

            saveState();
            syncInputs();
            renderAll();
            return true;
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (applyImportedData(data)) {
                        alert("匯入成功。");
                    }
                } catch (error) {
                    alert("檔案內容不是有效的 JSON。");
                }
            };
            reader.readAsText(file);
            event.target.value = "";
        }

        function init() {
            loadState();
            const settled = handleDateRollover();
            if (settled) {
                return;
            }
            syncInputs();
            renderAll();
        }

        cashInput.addEventListener("input", (event) => {
            state.cash = Number(event.target.value || 0);
            saveState();
            renderTotals();
        });

        stockInput.addEventListener("input", (event) => {
            state.stock = Number(event.target.value || 0);
            saveState();
            renderTotals();
        });

        addEventBtn.addEventListener("click", addEvent);
        clearEventsBtn.addEventListener("click", clearEvents);
        exportBtn.addEventListener("click", handleExport);
        importBtn.addEventListener("click", () => importFileInput.click());
        importFileInput.addEventListener("change", handleImportFile);
        futureList.addEventListener("click", handleEventAction);
        pastList.addEventListener("click", handleEventAction);
        settleTodayBtn.addEventListener("click", () => {
            const today = toDateInputValue(new Date());
            settleToDate(today);
        });

        init();
    </script>
</body>
</html>
